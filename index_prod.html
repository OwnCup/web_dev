<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="owncup">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon"  href="favicon.webp"/>

  <title>OwnCup</title>
  <!-- <link rel="manifest" href="manifest.json"> -->


  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAd1s-Y0X8YgX4NfK14JySh1WeCNtFQYA8"></script>
  <style>
    :root {
      --color-bg: #1A1C1A;
      --color-font: #E1E3E1;
      --primary-color: #A8C97F;
      --full-logo-url: url(icons/cleanhub_logo_full_dark.svg);
    }

    @media (prefers-color-scheme: light) {
      :root {
        --color-bg: #F7F7F7;
        --color-font: #1A1C1A;
        --full-logo-url: url(icons/cleanhub_logo_full_light.svg);
        --primary-color: #8BA85C;
      }
    }

    body {
      background-color: var(--color-bg);
      color: var(--color-font);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: block;
      font-size: calc((5vh+5vw)/2);
      padding: 5% 0;
    }

    div {
      display: block;
      padding: 3%;
      text-align: center;
    }

    .text {
      text-align: center;
      max-width: 600px;
      margin: auto;
    }


    a {
      color: var(--primary-color);
      text-decoration: none;
      cursor: pointer;
    }

    a:hover {
      text-decoration: underline;
    }

    header {
      display: block;
    }

    .logo {
      background-image: var(--full-logo-url);
      border: 0;
      background-repeat: no-repeat;
      margin: auto;
      width: 80%;
      max-height: 60px;
      min-height: 40px;
      background-position: center;
    }

    .buttons {
      display: block;
    }

    .buttons img,
    .buttons a {
      width: 85%;
      display: inline-block;
      margin: 8px auto;
      max-width: 300px;
      display: inline-block;
      vertical-align: middle;
    }


  </style>
</head>
<body>
  <script>
    //https://github.com/kotstok/deeplink/blob/master/app.html
    function unescapeHtml(input) {
      let d = document.createElement('div');
      d.innerHTML = input;
      let child = d.childNodes[0];
      return child ? child.nodeValue : null;
    }

    function validateProtocol(url) {
      let parser = document.createElement('a');
      parser.href = url;

      let protocol = parser.protocol.toLowerCase();

      if (['javascript:', 'vbscript:', 'data:', 'ftp:', ':', ' '].indexOf(protocol) < 0) {
        return url;
      }

      return null;
    }

    function validate(url) {
      let unescaped_value = unescapeHtml(url);

      if (unescaped_value && validateProtocol(unescaped_value)) {
        return unescaped_value;
      }

      return '/';
    }

    let s_URI = false;
    let intervalExecuted = false;

    window.onload = function () {
      //change favicon when dark mode
      // if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      //   // dark mode
      //   var link = document.querySelector("link[rel~='icon']");
      //   if (!link) {
      //     link = document.createElement('link');
      //     link.rel = 'icon';
      //     document.head.appendChild(link);
      //   }
      //   link.href = 'icons/icon_small_dark.svg';
      // }

      //deeplinks
      openDeepLink();

      //load localized version based on browser language
      var userLang = navigator.language || navigator.userLanguage;
      if (userLang.toLowerCase().includes("en")) {
        loadEnglishLocalisation();
      } else if (userLang.toLowerCase().includes("bg")) {
        loadBulgarianLocalisation();
      }
    };



    window.onblur = function () {
      s_URI = true;
    };

    window.onfocus = function () {
      if (s_URI || intervalExecuted) {
        // loadApp();
      }
    }

    function openDeepLink(force = false) {
      var query = window.location;
      var uri = new URL(query);

      if(!force && uri.searchParams.has("redirect") && uri.searchParams.get("redirect") === "true") {
        return;
      }

      uri.protocol = "owncup";
      uri.host = "app.owncup.eu";
      uri.searchParams.set("redirect", "true");
      var finalLocation = uri.toString();

      if (query.href.includes("localhost")) {
        //for test purposes on localhost
        finalLocation = "owncup://owncup.eu/about?redirect=true";
      }



      //Mozilla and another
      document.getElementById("l").src = validate(finalLocation);
      //Chome
      window.top.location = validate(finalLocation);
    }

    function loadApp() {
      document.body.innerHTML = "";
      
      // Create and load the Flutter bootstrap script
      const script = document.createElement('script');
      script.src = 'flutter_bootstrap.js';
      script.async = true;
      script.onload = function() {
        // The Flutter app will take over the page
        console.log('Flutter app loaded');
      };
      script.onerror = function() {
        // If Flutter fails to load, show an error message
        document.body.style.display = 'block';
        document.body.innerHTML = '<div style="text-align: center; padding: 20px;"><h2>Error loading app</h2><p>Please try refreshing the page.</p></div>';
      };
      
      document.body.appendChild(script);
    }

    function loadEnglishLocalisation() {
      document.getElementById("not_adapted").innerHTML = "The <b>OwnCup</b> app is not adapted to the web. We recommend using the <a>iOs</a> or <a>Andorid</a> version.";
      document.getElementById("app_installed").innerHTML = 'Already installed the app? <a onclick="openDeepLink(true);">Click here to open the in-app page</a>';
      document.getElementById("open_web").innerHTML = 'Or you can <a onclick="loadApp();">continue in the web version</a> (not recommended, some features may not work)';
    }

    function loadBulgarianLocalisation() {
      document.getElementById("not_adapted").innerHTML = "Приложението <b>OwnCup</b> не е адаптирано за уеб. Препоръчваме да използвате версията за <a>iOs</a> или <a>Android</a>.";
      document.getElementById("app_installed").innerHTML = 'Вече инсталирано приложение? <a onclick="openDeepLink(true);">Натиснете тук, за да отворите страницата в приложението</a>';
      document.getElementById("open_web").innerHTML = 'Или можете да <a onclick="loadApp();">продължите в уеб версията</a> (не се препоръчва, някои функции може да не работят)';
    }

  </script>
  <iframe height="1" id="l" style="visibility:hidden" width="1"></iframe>

  <header>
    <div class="logo"/>
  </header>
  <div class="text" id="not_adapted">
    Приложение <b>OwnCup</b> не адаптировано для web. Рекомендуем воспользоваться версией для <a>iOs</a>
    или <a>Andorid</a>.
  </div>

  <div class="buttons">
    <a href="https://owncup.eu"><img src="https://cleanhub.app/icons/google-play-badge.svg"></a>
    <a href="https://owncup.eu"><img
            src="https://cleanhub.app/icons/Download_on_the_App_Store_Badge_US-UK_RGB_wht_092917.svg"></a>
  </div>

  <div id="app_installed">
    Уже установлено приложение? <a onclick="openDeepLink(true);">Нажмите сюда, чтобы открыть страницу в
    приложении</a>
  </div>
  <div id="open_web">
    Или вы можете <a onclick="loadApp();">продолжить в web-версии</a> (не рекомендуется, некоторые
    функции могут не
    работать)
  </div>
  
</body>
</html>
